## Cookies (куки): 
`Cookie` (куки, печенье) - это небольшой объем именованных данных (в текстовом виде), сохраняемых браузером и связанных с определенной веб-страницей или веб-приложением. `Cookies` играют роль памяти веб браузера, чтобы сценарии и программы на стороне сервера могли на одной странице работать с данными, введенными на другой странице, или чтобы браузер мог вспомнить пользовательские параметры или другие переменные состояния, когда возвращается на страницу, посещенную им ранее. Данные `cookie` автоматически передаются между веб-клиентом и веб-сервером, так что серверные сценарии могут читать и записывать значения `cookie`, сохраняемые на стороне клиента.

Кроме входов в аккаунты они умеют запоминать:
- предпочтения пользователей, например, язык, валюту или размер шрифта
- товары, которые мы просматривали или добавили в корзину
- текст, который мы вводили на сайте раньше
- IP-адрес и местоположение пользователя
- дату и время посещения сайта
- версию ОС и браузера
- клики и переходы по сайтам

## Для чего используются?
- Управления сеансом (логины, корзины для виртуальных покупок)
- Персонализация (пользовательские предпочтения)
- Мониторинг (отслеживания поведения пользователя)

## Как работают куки?

Состояние `нет cookie`:
> событие в веб-приложении > формирование клиентского запроса без куки > сервер проверяет запрос и формиует ответ согласно отсутствии куки

Состояние `получение cookie`:
> событие в веб-приложении > формирование клиентского запроса без куки > сервер проверяет запрос и формиует ответ с заголовком установки куки

Состояние `есть cookie`:
> событие в веб-приложении > формирование клиентского запроса с кукой > сервер проверяет запрос и формиует ответ согласно наличия куки

## Атрибуты cookie:

> Помимо обязательного имени (`name`) и значения (`value`) каждый `cookie` имеет несколько необязательных атрибута, управляющих временем его жизни, видимостью и безопасностью.

- `expire` - по умолчанию `cookies` являются временными (сеансовыми/сессионными) – их значения сохраняются на период сеанса браузера и теряются при закрытии сеанса пользователем. Чтобы `cookie` сохранялся после окончания сеанса, необходимо сообщить браузеру, как долго он должен храниться. Изначально для этого использовался атрибут `expire`, указывающий дату окончания действия cookie. Значение expire записывается в формате "Wdy, DD Mon YYYY HH:MM:SS GMT". Если этот атрибут не задан, то `cookie` хранится в течение одного сеанса, до закрытия браузера.

- `max-age` - аналогичен атрибуту `expires`, но срок хранения определяется в секундах. Значение десятичное неотрицательное целое число. По истечении заданного времени клиент должен отказаться от куки. Значение ноль означает, что от `cookie` нужно отказаться немедленно.

> Установка значения любого из этих атрибутов(`expires`, `max-age`) заставляет браузер сохранить `cookie` в локальном файле, чтобы он мог быть прочитан при следующем посещении пользователем веб страницы. После того как будет достигнута дата окончания действия `expires` или истечет период `max-age`, браузер автоматически удалит `cookie` файл.

- `path` - задает веб страницы, с которыми связан `cookie`. По умолчанию `cookie` связывается с создавшей его веб страницей и доступен этой же странице, а также любой другой странице из того же каталога или любых его подкаталогов. Если, например, веб страница http://www.example.com/catalog/index.html создает `cookie`, то этот `cookie` будет также видим страницам http://www.example.com/catalog/order.html и http://www.example.com/catalog/widgets/index.html, но не видим странице http://www.example.com/about.html. Этого правила видимости, принятого по умолчанию, обычно вполне достаточно. Тем не менее иногда значения cookie файла требуется использовать на всем многостраничном веб сайте независимо от того, какая страница создала `cookie`. Чтобы это можно было сделать, для cookie файла задается значение path(path=/;). Тогда любая страница того же веб сервера, содержащая указанное значение в своем `URL`, сможет использовать `cookie` файл.

- `domain` - по умолчанию `cookies` доступны только страницам, загружаемым с того веб сервера, который их установил. Однако большим веб сайтам может потребоваться возможность совместного использования `cookies` несколькими веб серверами. Если атрибут `domain` для `cookie` не установлен, значением по умолчанию будет имя веб сервера, на котором находится страница. Обратите внимание, что нельзя сделать так, чтобы домен `cookie` файла отличался от домена вашего сервера.

- `secure` - это логический атрибут с именем secure, определяющий, как значения cookie файла передаются по сети. По умолчанию cookie не защищен, т. е. передается по обычному незащищенному HTTP соединению. Однако если cookie помечен как защищенный, он передается, только когда обмен между броузером и сервером организован по протоколу HTTPS или другому защищенному протоколу. По умолчанию принимает значение false.

- `samesite` запрещает браузеру отправлять куки с запросами, поступающими извне, помогает предотвратить XSRF-атаки.

## HTTPonly:    
Куки `HTTPonly` не доступны из JavaScript через свойства `document.cookie` API, что помогает избежать межсайтового скриптинга (XSS). Устанавливайте этот флаг для тех cookie, к которым не требуется обращаться через JavaScript. В частности, если куки используются только для поддержки сеанса, то в JavaScript они не нужны, так что в этом случае следует устанавливать флаг `HttpOnly`.

## Способы установки сookie:
- установка через клиент:
    - сессионая кука (удаляется при закрытии браузера):
    ```
    // cеттер для добавления или перезаписи куки с таким же именем
    document.cookie = 'test=42';
    ```
    - постоянная кука (удаляется при истечении срока):
    ```
    document.cookie = "test=42; max-age=90; path=/";
    ```
- установка через сервер:
    - сессионая кука (удаляется при закрытии браузера):
    ```
    // метод .cookie() не завершает запрос
    res.cookie('test', 42); 
    ```
    - постоянная кука (удаляется при истечении срока):
    ```
    res.cookie('test', 42, {
        maxAge: 90000,
        httpOnly: true,
    });

    ```
## Способы чтения сookie:
- чтение на клиенте:
```
// геттер, возвращает строку со всеми доступными куками
document.cookie
```
- чтение на сервере:
```
const cookieParser = require('cookie-parser');
app.use(cookieParser());

app.get('/my-cookies', (req, res) => {
 console.log(req.cookies); // { test: '42' }
 res.json(req.cookies);
});

```

## Способы удаления сookie:
- удаление на клиенте:
```
document.cookie = "test=; expires=Thu, 01 Jan 1970 00:00:00 GMT";
// или
document.cookie = "test=; max-age=0";
```
- удаление на сервере:
```
// удалить куку с сервера по ключу
// метод clearCookie не завершает запрос
res.clearCookie('user_id');
```

## Сессии в браузере (sessionStorage):
Свойство `sessionStorage` позволяет получить доступ к объекту `Storage` текущей сессии. Свойство `sessionStorage` очень похоже на свойство `Window.localStorage`, единственное различие заключается в том, что все данные, сохранённые в `localStorage` не имеют определённого времени жизни, а данные в `sessionStorage` очищаются в момент окончания сессии текущий страницы. Сессия страницы остаётся активной все время пока окно браузера открыто и сохраняется между перезагрузками страниц. Открытие той же страницы в новом окне браузера или новой вкладке приводит к созданию новой сессии страницы, что отличается от поведения `session cookies`.

```
if (sessionStorage.getItem('showPreloader') == null) {
    sessionStorage.setItem('showPreloader', 'true');
    alert('Test!')
}
```

## Конфигурация серверных сессий в Express:

```
const session = require('express-session');

const sessionConfig = {
 name: 'user_sid', 				// Имя куки для хранения id сессии. По умолчанию - connect.sid
 secret: process.env.SESSION_SECRET ?? 'test',	// Секретное слово для шифрования, может быть любым
 resave: false, 				// Пересохранять ли куку при каждом запросе
 saveUninitialized: false, 		// Создавать ли сессию без инициализации ключей в req.session
 cookie: {
   maxAge: 1000 * 60 * 60 * 12, // Срок истечения годности куки в миллисекундах
   httpOnly: true, 				// Серверная установка и удаление куки, по умолчанию true
 },
};

app.use(session(sessionConfig));
```

## Middleware при работе сессий:
```
app.use((req, res, next) => {
  if (req.session) {
    res.locals.user = req.session.user;
  }

  next();
});
```

## План:
- `Cookies` в теории: что это такое, для чего нужно, как работает?
- Установка, чтение, удаление `cookie` через клиент
- Установка, чтение, удаление `cookie` через сервер
- Серверная сессия в теории
- Подключение сессий в `Express` и её конфигурирование
- Библиотека хэширования `bcrypt` для шифрования паролей в БД
- Разбор скелетона
